databaseChangeLog:

  # -------------------------------------------------------
  # 1) PIERWSZA TABELA: farm_leads
  # -------------------------------------------------------
  - changeSet:
      id: 1-create-farm-leads-table
      author: you
      changes:
        - createTable:
            tableName: farm_leads
            columns:
              - column:
                  name: id
                  type: BIGINT
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_farm_leads
                    nullable: false

              - column:
                  name: email
                  type: VARCHAR(255)
                  constraints:
                    nullable: false

              - column:
                  name: source_url
                  type: VARCHAR(255)

              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP

              - column:
                  name: active
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false

        - addUniqueConstraint:
            tableName: farm_leads
            columnNames: email
            constraintName: uk_farm_leads_email

        - addAutoIncrement:
            tableName: farm_leads
            columnName: id
            columnDataType: BIGINT

  # -------------------------------------------------------
  # 2) DODANIE unsubscribe_token + nowo wymaganych pól
  # -------------------------------------------------------
  - changeSet:
      id: 2-add-outreach-columns-to-farm-leads
      author: you
      changes:
        - addColumn:
            tableName: farm_leads
            columns:
              - column:
                  name: first_email_sent_at
                  type: TIMESTAMP

              - column:
                  name: last_email_sent_at
                  type: TIMESTAMP

              - column:
                  name: unsubscribe_token
                  type: VARCHAR(255)

        - addUniqueConstraint:
            tableName: farm_leads
            columnNames: unsubscribe_token
            constraintName: uk_farm_leads_unsubscribe_token

  # -------------------------------------------------------
  # 3) serp_query_cursor
  # -------------------------------------------------------
  - changeSet:
      id: 003-create-serp-query-cursor
      author: mike
      changes:
        - createTable:
            tableName: serp_query_cursor
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: query
                  type: VARCHAR(500)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: current_page
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: max_page
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: last_run_at
                  type: TIMESTAMP

  # -------------------------------------------------------
  # 4) discovery_run_stats
  # -------------------------------------------------------
  - changeSet:
      id: 004-create-discovery-run-stats
      author: mike
      changes:
        - createTable:
            tableName: discovery_run_stats
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: query
                  type: VARCHAR(500)
                  constraints:
                    nullable: false

              - column:
                  name: started_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false

              - column:
                  name: finished_at
                  type: TIMESTAMP

              - column:
                  name: start_page
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: end_page
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: pages_visited
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: raw_urls
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: cleaned_urls
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: accepted_urls
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: rejected_urls
                  type: INT
                  constraints:
                    nullable: false

              - column:
                  name: errors
                  type: INT
                  constraints:
                    nullable: false

  # -------------------------------------------------------
  # 5) discovered_urls
  # -------------------------------------------------------
  - changeSet:
      id: 2025-11-17-01-create-discovered-urls
      author: mike
      changes:
        - createTable:
            tableName: discovered_urls
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: url
                  type: VARCHAR(1000)
                  constraints:
                    nullable: false

              - column:
                  name: is_farm
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false

              - column:
                  name: is_seasonal_jobs
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false

              - column:
                  name: first_seen_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false

              - column:
                  name: last_seen_at
                  type: TIMESTAMP
                  constraints:
                    nullable: false

        - addUniqueConstraint:
            tableName: discovered_urls
            columnNames: url
            constraintName: uk_discovered_urls_url

        - createIndex:
            tableName: discovered_urls
            indexName: idx_discovered_urls_first_seen_at
            columns:
              - column:
                  name: first_seen_at

  # -------------------------------------------------------
  # 5b) discovered_urls: add domain (KROK 2)
  # -------------------------------------------------------
  - changeSet:
      id: 2026-01-28-01-add-domain-to-discovered-urls
      author: mike
      changes:
        - addColumn:
            tableName: discovered_urls
            columns:
              - column:
                  name: domain
                  type: VARCHAR(255)

        - createIndex:
            tableName: discovered_urls
            indexName: idx_discovered_urls_domain
            columns:
              - column:
                  name: domain

        # Backfill domain from url (works in Postgres + usually in H2 2.x with regexp_replace)
        - sql:
            splitStatements: false
            sql: |
              UPDATE discovered_urls
              SET domain = LOWER(
                  REGEXP_REPLACE(url, '^(https?://)?(www\.)?([^/]+).*$','\3')
              )
              WHERE domain IS NULL OR domain = '';


  # -------------------------------------------------------
  # 6) Add filtered_already_discovered
  # -------------------------------------------------------
  - changeSet:
      id: add-filtered-already-discovered-to-discovery-run-stats
      author: mike
      changes:
        - addColumn:
            tableName: discovery_run_stats
            columns:
              - column:
                  name: filtered_already_discovered
                  type: INT
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false

  # -------------------------------------------------------
  # 7) farm_sources
  # -------------------------------------------------------
  - changeSet:
      id: 003-create-farm-sources
      author: mike
      changes:
        - createTable:
            tableName: farm_sources
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: domain
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: last_scraped_at
                  type: TIMESTAMP

  - changeSet:
      id: 5-2-add-bounce-column
      author: you
      changes:
        - addColumn:
            tableName: farm_leads
            columns:
              - column:
                  name: bounce
                  type: BOOLEAN
                  defaultValueBoolean: false

  - changeSet:
      id: 5-3-bounce-not-null-default
      author: you
      changes:
        - addDefaultValue:
            tableName: farm_leads
            columnName: bounce
            defaultValueBoolean: false

        - update:
            tableName: farm_leads
            columns:
              - column:
                  name: bounce
                  value: "false"
            where: bounce IS NULL

        - addNotNullConstraint:
            tableName: farm_leads
            columnName: bounce
            columnDataType: BOOLEAN

  - changeSet:
      id: ajb-cursor-001
      author: mike
      changes:
        - createTable:
            tableName: ajb_cursor
            columns:
              - column:
                  name: id
                  type: INT
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: next_page
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP

        # Jeden rekord na stałe
        - insert:
            tableName: ajb_cursor
            columns:
              - column:
                  name: id
                  valueNumeric: "1"
              - column:
                  name: next_page
                  valueNumeric: "0"
              - column:
                  name: updated_at
                  valueComputed: NOW()

